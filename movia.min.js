const moviaStack=[];function getTopMovia(){return moviaStack[moviaStack.length-1]||null}export const MoviaGlobal={defaultCloseMethods:["button","overlay","escape"],defaultCssClass:[],destroyOnClose:!1,autoSanitize:!0,set(t={}){Object.assign(this,t)}};let moviaIdCounter=0;export class Movia{footerButton=[];onOpen=null;onClose=null;constructor(t={}){const e={templatedId:null,content:"",closeMethods:MoviaGlobal.defaultCloseMethods.slice(),destroyOnClose:MoviaGlobal.destroyOnClose,footer:!1,cssClass:MoviaGlobal.defaultCssClass.slice(),onOpen:null,onClose:null,footerButton:[]},n=Object.assign({},e,t);Object.assign(this,n),this.id=++moviaIdCounter,this.isOpen=!1,this.backdrop=null,this.footerElement=null,this.contentElement=null,this._pendingContent=null,this._pendingFooterButtons=[],this._pendingFooterContent=null,this._footerInitialized=!1,this._keydownHandler=null,this._childMovias=[]}createMovia(){if(this.backdrop)return this.backdrop;const t=document.createElement("div");t.className="movia-backdrop",t.id=`movia-${this.id}`;const e=document.createElement("div");if(e.className="movia-container",Array.isArray(this.cssClass)&&this.cssClass.length&&this.cssClass.forEach(t=>{"string"==typeof t&&t.trim()&&e.classList.add(t)}),Array.isArray(this.closeMethods)&&this.closeMethods.includes("button")){const t=this._createButton("&times;","movia-close",this.close.bind(this));e.appendChild(t)}const n=document.createElement("div");if(n.className="movia-content",this.templatedId){const t=document.getElementById(this.templatedId);t&&t.content?n.appendChild(t.content.cloneNode(!0)):n.innerHTML=String(this.content??"")}else n.innerHTML=String(this.content??"");if(this.contentElement=n,e.append(n),Array.isArray(this.closeMethods)&&this.closeMethods.includes("overlay")&&t.addEventListener("click",e=>{e.target===t&&this.close()}),Array.isArray(this.closeMethods)&&this.closeMethods.includes("escape")&&(this._keydownHandler=t=>{if("Escape"===t.key){getTopMovia()===this&&this.close()}}),this.footer){const t=document.createElement("div");t.className="movia-footer",this.footerElement=t,this.footerElement.innerHTML="",null!==this._pendingFooterContent&&(this.footerElement.innerHTML=this._pendingFooterContent,this._pendingFooterContent=null),!this._footerInitialized&&this.footerButton?.length&&(this.footerButton.forEach(e=>{const n=this._createButton(e.label,e.classNames,e.onClick);t.append(n)}),this._footerInitialized=!0),Array.isArray(this._pendingFooterButtons)&&this._pendingFooterButtons?.length&&(this._pendingFooterButtons.forEach(e=>{const n=this._createButton(e.label,e.classNames,e.onClick);t.appendChild(n)}),this._pendingFooterButtons=[]),e.append(t)}return t.append(e),this.backdrop=t,t}updateContent(t){if(MoviaGlobal.autoSanitize&&(t=this.sanitizeHTML(t)),!this.backdrop)return void(this._pendingContent=t);const e=this.backdrop.querySelector(".movia-content");this.isOpen&&e?e.innerHTML=t:this._pendingContent=t,this.content=t}setFooterContent(t){MoviaGlobal.autoSanitize&&(t=this.sanitizeHTML(t)),this.footerElement?this.footerElement.innerHTML=t:this._pendingFooterContent=t}sanitizeHTML(t){if(!MoviaGlobal.autoSanitize)return String(t??"");const e=(new DOMParser).parseFromString(String(t),"text/html"),n=["onerror","onclick","onload","oninput","onchange","onmouseover"];return["script","iframe","embed","object","link","meta"].forEach(t=>{e.querySelectorAll(t).forEach(t=>t.remove())}),e.querySelectorAll("*").forEach(t=>{[...t.attributes].forEach(e=>{const o=e.name.toLowerCase(),i=e.value;o.startsWith("on")||n.includes(o)?t.removeAttribute(o):"href"!==o&&"src"!==o||!i.trim().toLowerCase().startsWith("javascript:")||t.removeAttribute(o)})}),e.body.innerHTML}renderLabel(t){if(t instanceof HTMLElement)return t.cloneNode(!0);if("function"==typeof t)try{return this.renderLabel(t())}catch(t){return this._createSpan(String(t))}if("string"!=typeof t)return this._createSpan(String(t));if(!/[<>]/.test(t))return this._createSpan(t);const e=document.createElement("span");return e.innerHTML=this.sanitizeHTML(t),e}_createSpan(t){const e=document.createElement("span");return e.textContent=String(t),e}_createButton(t,e="",n=null){const o=document.createElement("button");if(o.type="button",Array.isArray(e)?e.filter(Boolean).forEach(t=>o.classList.add(t)):"string"==typeof e&&e.trim()&&e.split(/\s+/).forEach(t=>o.classList.add(t)),"function"==typeof n&&o.addEventListener("click",t=>{n.call(this,t)}),"string"==typeof t&&/^&[a-zA-Z0-9]+;?$/.test(t))o.innerHTML=t;else{const e=this.renderLabel(t);DocumentFragment,o.appendChild(e)}return o}addFooterButton(t={}){if(!t||"object"!=typeof t)return;if(!this.footerElement){return void(this._pendingFooterButtons.some(e=>e.label===t.label)||this._pendingFooterButtons.push({label:t.label,classNames:t.classNames,onClick:t.onClick}))}if(!Array.from(this.footerElement.children).some(e=>e.textContent.trim()===String(t.label).trim())){const e=this._createButton(t.label,t.classNames,t.onClick);this.footerElement.appendChild(e)}}setupChildMovia(t){t&&(this._childMovias.push(t),this.isOpen&&this.backdrop&&this._attachChildOpenHandler(t))}_attachChildOpenHandler(t){this.backdrop&&this.backdrop.addEventListener("click",e=>{const n=e.target.closest("[data-open-movia]");if(!n)return;const o=n.dataset.openMovia??n.getAttribute("data-open-movia");o&&(o!==t.templatedId&&o!==String(t.id)||t.open())})}open(){if(this.isOpen)return;this.isOpen=!0,moviaStack.push(this);const t=this.backdrop||this.createMovia();if(this._childMovias.length&&this._childMovias.forEach(t=>{this._attachChildOpenHandler(t)}),document.body.contains(t)||document.body.appendChild(t),null!==this._pendingContent){const e=t.querySelector(".movia-content");e&&(e.innerHTML=this._pendingContent),this._pendingContent=null}this._keydownHandler&&document.addEventListener("keydown",this._keydownHandler);const e=this._getScrollbarWidth();document.body.classList.add("no-scroll");const n=document.body.style.paddingRight||"";document.body.style.paddingRight=`${(parseFloat(n)||0)+e}px`,this._preBodyPaddingRight=n,t.style.visibility="",t.classList.add("show"),requestAnimationFrame(()=>{if(t.dispatchEvent(new CustomEvent("movia:ready")),"function"==typeof this.onReady)try{this.onReady()}catch(t){console.log(t)}}),this._onTransitionEnd(t,()=>{if("number"==typeof this._saveScroll){const e=t.querySelector(".movia-content");e&&(e.scrollTop=this._saveScroll)}if("function"==typeof this.onOpen)try{this.onOpen()}catch(t){console.error(t)}})}close(t=!1){if(!this.isOpen||!this.backdrop)return;const e=moviaStack.indexOf(this);-1!==e&&moviaStack.splice(e,1),this.isOpen=!1;const n=this.backdrop,o=n.querySelector(".movia-content");if(this._saveScroll=o.scrollTop,moviaStack.length){const t=this._getScrollbarWidth();document.body.style.paddingRight=`${t}px`}else document.body.classList.remove("no-scroll"),void 0!==this._preBodyPaddingRight&&(document.body.style.paddingRight=this._preBodyPaddingRight,delete this._preBodyPaddingRight),document.body.style.paddingRight="";let i;if(n.classList.remove("show"),this._keydownHandler&&document.removeEventListener("keydown",this._keydownHandler),null===this.destroyOnClose||void 0===this.destroyOnClose){const t=n.querySelector(".movia-container"),e=t.scrollHeight>t.clientHeight;i=!e}else i=t||this.destroyOnClose;this._onTransitionEnd(n,()=>{if(i?(n.remove(),this.backdrop=null,this.footerElement=null,this._footerInitialized=!1):n.style.visibility="hidden",this._pendingFooterButtons=[],this._pendingFooterContent=null,this._pendingContent=null,"function"==typeof this.onClose)try{this.onClose()}catch(t){console.log(t)}})}destroy(){this.close(!0)}_onTransitionEnd(t,e){if(!t)return void e?.();let n=!1;const o=()=>{if(!n){n=!0,t.removeEventListener("transitionend",i),clearTimeout(s);try{e?.()}catch(t){console.error(t)}}},i=e=>{e.target===t&&o()};t.addEventListener("transitionend",i);const s=setTimeout(o,350)}_getScrollbarWidth(){if("number"==typeof this._scrollbarWidth)return this._scrollbarWidth;const t=document.createElement("div");return Object.assign(t.style,{overflow:"scroll",position:"absolute",top:"-9999px",width:"100px",height:"100px"}),document.body.appendChild(t),this._scrollbarWidth=t.offsetWidth-t.clientWidth,document.body.removeChild(t),this._scrollbarWidth}}