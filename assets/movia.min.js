let activeScrollLockOwner=null;const moviaStack=[];function getTopMovia(){return moviaStack[moviaStack.length-1]||null}function getTopScrollLockMovia(){for(let t=moviaStack.length-1;t>=0;t--)if(moviaStack[t].enableScrollLock)return moviaStack[t];return null}function updateScrollLock(){const t=getTopScrollLockMovia();t!==activeScrollLockOwner&&(activeScrollLockOwner&&activeScrollLockOwner._unlockScrollIfOwner(),t&&(t._activeScrollLockTarget=t._resolveScrollLockTarget(),t._lockScroll()),activeScrollLockOwner=t)}const ALLOWED_KEYS=["defaultCloseMethods","defaultCssClass","destroyOnClose","autoSanitize","scrollLockTarget","enableScrollLock"];export const MoviaGlobal={defaultCloseMethods:["button","overlay","escape"],defaultCssClass:[],destroyOnClose:!1,autoSanitize:!0,scrollLockTarget:null,enableScrollLock:!0,set(t={}){Object.keys(t).forEach(e=>{ALLOWED_KEYS.includes(e)?this[e]=t[e]:console.warn(`[Movia] Invalid global config key: "${e}"`)})}};let moviaIdCounter=0;export class Movia{templateId=null;content="";template=null;closeMethods=[];destroyOnClose=!1;enableScrollLock=!0;preserveScrollPosition=!1;scrollLockTarget=null;footer=!1;cssClass=[];footerButton=[];onOpen=null;onClose=null;constructor(t={}){const e={templateId:null,content:"",closeMethods:MoviaGlobal.defaultCloseMethods.slice(),destroyOnClose:MoviaGlobal.destroyOnClose,cssClass:MoviaGlobal.defaultCssClass.slice(),enableScrollLock:MoviaGlobal.enableScrollLock,scrollLockTarget:null,footer:!1,footerButton:[],onOpen:null,onClose:null,preserveScrollPosition:!1},o=Object.assign({},e,t);if(Object.assign(this,o),!this.content&&!this.templateId)throw new Error("Movia requires either 'content' or 'templateId' to be provided.");if(this.content&&this.templateId&&(this.content=null,console.warn("Both 'content' and 'templateId' are provided. 'templateId' will take precedence.")),this.templateId){const t=document.getElementById(this.templateId);if(!t)throw new Error(`[Movia] Template with id "${this.templateId}" does not exist.`);this.template=t}else this.template=null;this.id=++moviaIdCounter,this.isOpen=!1,this.backdrop=null,this.footerElement=null,this.contentElement=null,this._childOpenHandler=null,this._isMounted=!1,this._isDestroyed=!1,this._pendingContent=null,this._pendingFooterButtons=[],this._pendingFooterContent=null,this._footerInitialized=!1,this._keydownBound=!1,this._keydownHandler=null,this._childMovias=[],this._parentMovia=null,this._isScrollLocked=!1,this._activeScrollLockTarget=null,this._preScrollPaddingRight=null}createMovia(){if(this.backdrop)return this.backdrop;const t=document.createElement("div");t.className="movia",t.id=`movia-${this.id}`;const e=document.createElement("div");if(e.className="movia__container",Array.isArray(this.cssClass)&&this.cssClass.length&&this.cssClass.forEach(t=>{"string"==typeof t&&t.trim()&&e.classList.add(t)}),Array.isArray(this.closeMethods)&&this.closeMethods.includes("button")){const t=this._createButton("&times;","movia__close",this.close.bind(this));e.appendChild(t)}const o=document.createElement("div");if(o.className="movia__content",this.templateId){const t=document.getElementById(this.templateId);t&&t.content?o.appendChild(t.content.cloneNode(!0)):o.innerHTML=String(this.content??"")}else o.innerHTML=String(this.content??"");if(this.contentElement=o,e.append(o),Array.isArray(this.closeMethods)&&this.closeMethods.includes("overlay")&&t.addEventListener("click",e=>{e.target===t&&this.close()}),Array.isArray(this.closeMethods)&&this.closeMethods.includes("escape")&&(this._keydownHandler=t=>{if("Escape"===t.key){getTopMovia()===this&&this.close()}}),this.footer){const t=document.createElement("div");t.className="movia__footer",this.footerElement=t,this._renderFooter(),e.appendChild(t)}return t.append(e),this.backdrop=t,t}updateContent(t){if(MoviaGlobal.autoSanitize&&(t=this.sanitizeHTML(t)),!this.backdrop)return void(this._pendingContent=t);const e=this.backdrop.querySelector(".movia__content");this.isOpen&&e?e.innerHTML=t:this._pendingContent=t,this.content=t}setFooterContent(t){MoviaGlobal.autoSanitize&&(t=this.sanitizeHTML(t)),this.footerElement?this.footerElement.innerHTML=t:this._pendingFooterContent=t}sanitizeHTML(t){if(!MoviaGlobal.autoSanitize)return String(t??"");const e=(new DOMParser).parseFromString(String(t),"text/html"),o=["onerror","onclick","onload","oninput","onchange","onmouseover"];return["script","iframe","embed","object","link","meta"].forEach(t=>{e.querySelectorAll(t).forEach(t=>t.remove())}),e.querySelectorAll("*").forEach(t=>{[...t.attributes].forEach(e=>{const n=e.name.toLowerCase(),i=e.value;n.startsWith("on")||o.includes(n)?t.removeAttribute(n):"href"!==n&&"src"!==n||!i.trim().toLowerCase().startsWith("javascript:")||t.removeAttribute(n)})}),e.body.innerHTML}renderLabel(t){if(t instanceof HTMLElement)return t.cloneNode(!0);if("function"==typeof t)try{return this.renderLabel(t())}catch(t){return this._createSpan(String(t))}if("string"!=typeof t)return this._createSpan(String(t));if(!/[<>]/.test(t))return this._createSpan(t);const e=document.createElement("span");return e.innerHTML=this.sanitizeHTML(t),e}_createSpan(t){const e=document.createElement("span");return e.textContent=String(t),e}_createButton(t,e="",o=null){const n=document.createElement("button");if(n.type="button",Array.isArray(e)?e.filter(Boolean).forEach(t=>n.classList.add(t)):"string"==typeof e&&e.trim()&&e.split(/\s+/).forEach(t=>n.classList.add(t)),"function"==typeof o&&n.addEventListener("click",t=>{o.call(this,t)}),"string"==typeof t&&/^&[a-zA-Z0-9]+;?$/.test(t))n.innerHTML=t;else{const e=this.renderLabel(t);DocumentFragment,n.appendChild(e)}return n}addFooterButton(t={}){if(!t||"object"!=typeof t)return;[...this.footerButton,...this._pendingFooterButtons].some(e=>e.label===t.label)||(this.footerElement?(this.footerButton.push(t),this._renderFooter()):this._pendingFooterButtons.push(t))}_renderFooter(){this.footer&&this.footerElement&&(this._footerInitialized||(this.footerButton.push(...this._pendingFooterButtons),this._pendingFooterButtons=[],this._footerInitialized=!0),this.footerElement.innerHTML="",null!==this._pendingFooterContent&&(this.footerElement.innerHTML=this._pendingFooterContent),this.footerButton.forEach(t=>{const e=this._createButton(t.label,t.classNames,t.onClick);this.footerElement.appendChild(e)}))}setupChildMovia(t){t&&(this._childMovias.push(t),t._parentMovia=this,this.isOpen&&this.backdrop&&this._attachChildOpenHandler())}_attachChildOpenHandler(){this.backdrop&&(this._childOpenHandler||(this._childOpenHandler=t=>{const e=t.target.closest("[data-open-movia]");if(!e)return;const o=e.dataset.openMovia??e.getAttribute("data-open-movia");if(!o)return;const n=this._childMovias.find(t=>o===String(t.id)||o===t.templateId);n&&n.open()},this.backdrop.addEventListener("click",this._childOpenHandler)))}_resolveScrollLockTarget(){const t=this.scrollLockTarget??MoviaGlobal.scrollLockTarget??document.body;return"function"==typeof t?t():"string"==typeof t?document.querySelector(t):t instanceof HTMLElement?t:document.body}_hasScrollbar(t){if(t===document.body||document.documentElement){const t=document.documentElement,e=document.body;return t.scrollHeight>t.clientHeight||e.scrollHeight>e.clientHeight}return t.scrollHeight>t.clientHeight}_lockScroll(){if(this._isScrollLocked)return;const t=this._activeScrollLockTarget;if(!t)return;this._isScrollLocked=!0,this._preScrollPaddingRight=window.getComputedStyle(t).paddingRight||"";const e=this._hasScrollbar(t)?this._getScrollbarWidth():0;t.classList.add("movia--no-scroll"),t.style.paddingRight=`${(parseFloat(this._preScrollPaddingRight)||0)+e}px`}_unlockScrollIfOwner(){if(activeScrollLockOwner!==this)return;if(!this._isScrollLocked)return;const t=this._activeScrollLockTarget;t&&(t.classList.remove("movia--no-scroll"),t.style.paddingRight=this._preScrollPaddingRight,this._isScrollLocked=!1,this._activeScrollLockTarget=null,this._preScrollPaddingRight=null)}open(){if(this._isDestroyed)return void console.warn("Movia has been destroyed and cannot be reopened.");if(this.isOpen)return;if(this.isOpen=!0,moviaStack.push(this),updateScrollLock(),this._isMounted||(this.backdrop=this.createMovia(),document.body.appendChild(this.backdrop),this._isMounted=!0),this._childMovias.length&&this._attachChildOpenHandler(),document.body.contains(this.backdrop)||document.body.appendChild(this.backdrop),null!==this._pendingContent){const t=this.backdrop.querySelector(".movia__content");t&&(t.innerHTML=this._pendingContent),this._pendingContent=null}this._keydownHandler&&!this._keydownBound&&(document.addEventListener("keydown",this._keydownHandler),this._keydownBound=!0),this.backdrop.style.visibility="",requestAnimationFrame(()=>{this.backdrop.classList.add("movia--show"),this.backdrop.dispatchEvent(new CustomEvent("movia:ready")),this.onReady?.()});const t=this.backdrop;this._onTransitionEnd(t,()=>{if(this.isOpen){if(this.preserveScrollPosition&&"number"==typeof this._saveScroll){const e=t.querySelector(".movia__content");e&&(e.scrollTop=this._saveScroll)}this.onOpen?.()}})}close(t=!1){if(!this.isOpen||!this.backdrop)return;this.isOpen=!1;const e=moviaStack.indexOf(this);-1!==e&&moviaStack.splice(e,1);const o=this.backdrop;if(this.preserveScrollPosition){const t=o.querySelector(".movia__content");this._saveScroll=t.scrollTop}o.classList.remove("movia--show"),this._keydownHandler&&this._keydownBound&&(document.removeEventListener("keydown",this._keydownHandler),this._keydownBound=!1);const n=t||this.destroyOnClose;this._onTransitionEnd(o,()=>{updateScrollLock(),this.isOpen||(n?(this._childOpenHandler&&(o.removeEventListener("click",this._childOpenHandler),this._childOpenHandler=null),o.remove(),this.backdrop=null,this._isMounted=!1,this.footerElement=null,this._footerInitialized=!1,this._pendingFooterButtons=[],this._pendingFooterContent=null,this._pendingContent=null):o.style.visibility="hidden",this.onClose?.())})}_forceReleaseScrollLock(){activeScrollLockOwner===this&&(this._unlockScrollIfOwner(),activeScrollLockOwner=null)}destroy(){if(this._isDestroyed=!0,this._forceReleaseScrollLock(),this._parentMovia){const t=this._parentMovia._childMovias,e=t.indexOf(this);-1!==e&&t.splice(e,1),this._parentMovia=null}this.isOpen?this.close(!0):this.backdrop&&this.backdrop.remove()}_onTransitionEnd(t,e){if(!t)return void e?.();let o=!1;const n=()=>{if(!o){o=!0,t.removeEventListener("transitionend",i),clearTimeout(s);try{e?.()}catch(t){console.error(t)}}},i=e=>{e.target===t&&n()};t.addEventListener("transitionend",i);const s=setTimeout(n,350)}_getScrollbarWidth(){if("number"==typeof this._scrollbarWidth)return this._scrollbarWidth;const t=document.createElement("div");return Object.assign(t.style,{overflow:"scroll",position:"absolute",top:"-9999px",width:"100px",height:"100px"}),document.body.appendChild(t),this._scrollbarWidth=t.offsetWidth-t.clientWidth,document.body.removeChild(t),this._scrollbarWidth}}